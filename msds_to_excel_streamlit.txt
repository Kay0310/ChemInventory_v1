
import pytesseract
from PIL import Image, ImageEnhance, ImageFilter
import pandas as pd
import re
import os
import shutil
import streamlit as st
import tempfile

# === OCR ì „ì²˜ë¦¬ ===
def preprocess_image(image):
    image = image.convert('L')
    image = image.filter(ImageFilter.MedianFilter())
    enhancer = ImageEnhance.Contrast(image)
    image = enhancer.enhance(2)
    return image

# === ì œí’ˆëª… ì¶”ì¶œ ===
def extract_product_name(image):
    image = preprocess_image(image)
    text = pytesseract.image_to_string(image)
    match = re.search(r"Product identifier.*?:\s*(.*)", text)
    return match.group(1).strip() if match else "UNKNOWN"

# === í™”í•™ë¬¼ì§ˆ ì¶”ì¶œ ===
def extract_chemical_data(image):
    image = preprocess_image(image)
    text = pytesseract.image_to_string(image)
    lines = text.split("\n")
    data = []
    for line in lines:
        if re.search(r"\d{2,5}-\d{2}-\d", line):
            parts = re.split(r"\s{2,}|\t+", line.strip())
            if len(parts) >= 4:
                data.append(parts[:4])
            elif len(parts) == 3:
                data.append([parts[0], "None", parts[1], parts[2]])
    return data

# === Streamlit UI ===
st.title("ğŸ§ª MSDS ì´ë¯¸ì§€ â†’ í™”í•™ë¬¼ì§ˆ ì¸ë²¤í† ë¦¬ ìë™ ì¶”ì¶œ")

product_img = st.file_uploader("ì œí’ˆëª…ì´ í¬í•¨ëœ ì´ë¯¸ì§€ ì—…ë¡œë“œ", type=["png", "jpg", "jpeg"], key="product")
table_img = st.file_uploader("í™”í•™ë¬¼ì§ˆ í…Œì´ë¸” ì´ë¯¸ì§€ ì—…ë¡œë“œ", type=["png", "jpg", "jpeg"], key="table")

if product_img and table_img:
    with tempfile.NamedTemporaryFile(delete=False) as f1, tempfile.NamedTemporaryFile(delete=False) as f2:
        f1.write(product_img.read())
        f2.write(table_img.read())

        p_image = Image.open(f1.name)
        t_image = Image.open(f2.name)

        product_name = extract_product_name(p_image)
        chemical_data = extract_chemical_data(t_image)

        if chemical_data:
            df = pd.DataFrame(chemical_data, columns=[
                "3.í™”í•™ë¬¼ì§ˆëª…(í•„ìˆ˜)", "4.ê´€ìš©ëª…ë°ì´ëª…", "5.CASë²ˆí˜¸", "21.í•¨ìœ ëŸ‰"
            ])
            df.insert(0, "2.ì œí’ˆëª…", product_name)

            st.success(f"âœ… ì œí’ˆëª…: {product_name}")
            st.dataframe(df)

            # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
            csv = df.to_csv(index=False).encode('utf-8-sig')
            st.download_button(
                label="ğŸ“¥ ê²°ê³¼ Excel ë‹¤ìš´ë¡œë“œ",
                data=csv,
                file_name="msds_inventory.csv",
                mime="text/csv",
            )
        else:
            st.warning("â— í™”í•™ë¬¼ì§ˆ ë°ì´í„°ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ í’ˆì§ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
